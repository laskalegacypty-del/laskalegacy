<!DOCTYPE html>
<html>
<head>
  <title>Laska Legacy Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    body{font-family:sans-serif;max-width:1200px;margin:40px auto;padding:0 20px}
    input,select,button,textarea{padding:10px;margin:6px 0;width:100%;box-sizing:border-box}
    button{cursor:pointer;background:#0aa7a7;color:#fff;border:none;border-radius:6px;font-weight:600}
    button:hover{background:#078989}
    button:disabled{opacity:0.6;cursor:not-allowed}
    .section{margin:30px 0;padding:20px;background:#f9f9f9;border-radius:8px}
    .inquiry-item{background:#fff;padding:16px;margin:12px 0;border-radius:8px;border:1px solid #ddd;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px}
    .inquiry-info{flex:1;min-width:200px}
    .inquiry-meta{font-size:0.9em;color:#666;margin-top:4px}
    .status-badge{padding:4px 12px;border-radius:12px;font-size:0.85em;font-weight:600;display:inline-block}
    .status-pending{background:#fff3cd;color:#856404}
    .status-reviewed{background:#d1ecf1;color:#0c5460}
    .status-invoiced{background:#d4edda;color:#155724}
    .status-invoice-sent{background:#cfe2ff;color:#084298}
    .status-payment-received{background:#d1e7dd;color:#0f5132}
    .status-shipped{background:#d0d4f7;color:#3d3a8f}
    .download-link{color:#0aa7a7;text-decoration:none;font-weight:600;margin-left:8px}
    .download-link:hover{text-decoration:underline}
    .status-select{padding:4px 8px;border-radius:6px;border:1px solid #ddd;font-size:0.85em;font-weight:600;cursor:pointer;background:#fff}
    .status-select.status-pending{background:#fff3cd;color:#856404}
    .status-select.status-invoice-sent{background:#cfe2ff;color:#084298}
    .status-select.status-payment-received{background:#d1e7dd;color:#0f5132}
    .status-select.status-shipped{background:#d0d4f7;color:#3d3a8f}
    .status-select.status-invoiced{background:#d4edda;color:#155724}
    .status-select.status-reviewed{background:#d1ecf1;color:#0c5460}
    .status-select:focus{outline:2px solid #0aa7a7;outline-offset:2px}
    .btn-group{display:flex;gap:8px;flex-wrap:wrap}
    .btn-small{padding:6px 12px;font-size:0.9em;width:auto}
    .btn-secondary{background:#6c757d}
    .btn-secondary:hover{background:#5a6268}
    .modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:1000;overflow-y:auto;padding:20px}
    .modal-content{background:#fff;max-width:800px;margin:0 auto;padding:24px;border-radius:8px;position:relative}
    .modal-close{position:absolute;top:12px;right:12px;background:#dc3545;width:32px;height:32px;border-radius:50%;border:none;color:#fff;cursor:pointer;font-size:20px;line-height:1}
    .modal-close:hover{background:#c82333}
    .detail-row{margin:12px 0;padding:12px;background:#f9f9f9;border-radius:6px}
    .detail-label{font-weight:600;color:#333;margin-bottom:4px}
    .detail-value{color:#666}
    .items-list{margin:8px 0}
    .item-row{display:flex;justify-content:space-between;padding:8px;background:#fff;margin:4px 0;border-radius:4px}
    .totals-box{background:#e7f5f5;padding:16px;border-radius:6px;margin-top:16px}
    .totals-row{display:flex;justify-content:space-between;margin:8px 0}
    .totals-total{font-size:1.2em;font-weight:700;color:#0aa7a7;border-top:2px solid #0aa7a7;padding-top:8px;margin-top:8px}
    #result{margin-top:12px;padding:12px;background:#d4edda;color:#155724;border-radius:6px;display:none}
    #result a{color:#155724;font-weight:600;text-decoration:underline}
  </style>
</head>
<body>

<h2>Laska Legacy Admin</h2>

<div id="login">
  <input id="pwd" type="password" placeholder="Password"/>
  <button onclick="doLogin()">Login</button>
</div>

<div id="panel" style="display:none">
  <div class="section">
    <h3>Create Invoice (Manual)</h3>
    <textarea id="items" rows="6" placeholder='[{"name":"Leather Belt + Buckle","qty":2}]'></textarea>
    <select id="route">
      <option value="locker-locker">Locker â†’ Locker</option>
      <option value="locker-door">Locker â†’ Door</option>
      <option value="locker-kiosk">Locker â†’ Kiosk</option>
      <option value="kiosk-door">Kiosk â†’ Door</option>
    </select>
    <button onclick="createInvoice()">Generate Invoice</button>
    <div id="result"></div>
  </div>

  <div class="section">
    <h3>Client Inquiries</h3>
    <button onclick="loadInquiries()" class="btn-small" style="width:auto;margin-bottom:12px">Refresh</button>
    <div id="inquiries-list"></div>
  </div>
</div>

<div id="inquiry-modal" class="modal">
  <div class="modal-content">
    <button class="modal-close" onclick="closeModal()">Ã—</button>
    <div id="inquiry-detail"></div>
  </div>
</div>

<script>
let currentInquiry = null

async function doLogin(){
  const loginDiv = document.getElementById('login')
  const panelDiv = document.getElementById('panel')
  const pwdInput = document.getElementById('pwd')

  const r = await fetch('/api/admin-login',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ password: pwdInput.value })
  })

  if(r.ok){
    loginDiv.style.display='none'
    panelDiv.style.display='block'
    loadInquiries()
  } else {
    alert("Wrong password")
  }
}

async function createInvoice(){
  const items = document.getElementById('items').value
  const route = document.getElementById('route').value
  const result = document.getElementById('result')

  try {
    const r = await fetch('/api/create-invoice',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        items:JSON.parse(items),
        route:route
      })
    })

    const j = await r.json()
    result.style.display = 'block'
    result.innerHTML = `<a href="${j.url}" target="_blank">Download Invoice</a>`
  } catch(e) {
    result.style.display = 'block'
    result.innerHTML = 'Error: ' + e.message
  }
}

async function loadInquiries(){
  const listDiv = document.getElementById('inquiries-list')
  listDiv.innerHTML = '<p>Loading...</p>'

  try {
    const r = await fetch('/api/get-inquiries')
    if(!r.ok) throw new Error('Failed to load inquiries')
    
    const inquiries = await r.json()
    
    if(inquiries.length === 0) {
      listDiv.innerHTML = '<p>No inquiries yet.</p>'
      return
    }

    listDiv.innerHTML = inquiries.map(inq => `
      <div class="inquiry-item">
        <div class="inquiry-info">
          <div><strong>${inq.client.name}</strong> - ${inq.client.email}</div>
          <div class="inquiry-meta">
            ${new Date(inq.createdAt).toLocaleString()} | 
            ${inq.items.length} item(s) | 
            Total: R${inq.totals.total.toFixed(2)}
            ${inq.invoiceUrl ? ` | <a href="${inq.invoiceUrl}" target="_blank" class="download-link">ðŸ“„ Download Invoice</a>` : ''}
          </div>
        </div>
        <div class="btn-group">
          <select class="status-select status-${inq.status}" onchange="updateInquiryStatus('${inq.id}', this.value)">
            <option value="pending" ${inq.status === 'pending' ? 'selected' : ''}>Pending</option>
            <option value="invoice-sent" ${inq.status === 'invoice-sent' ? 'selected' : ''}>Invoice Sent</option>
            <option value="payment-received" ${inq.status === 'payment-received' ? 'selected' : ''}>Payment Received</option>
            <option value="shipped" ${inq.status === 'shipped' ? 'selected' : ''}>Shipped</option>
            <option value="invoiced" ${inq.status === 'invoiced' ? 'selected' : ''}>Invoiced</option>
          </select>
          <button class="btn-small btn-secondary" onclick="viewInquiry('${inq.id}')">View Details</button>
          <button class="btn-small" onclick="generateInvoiceFromInquiry('${inq.id}')" ${inq.status === 'invoiced' ? 'disabled' : ''}>Generate Invoice</button>
        </div>
      </div>
    `).join('')
  } catch(e) {
    listDiv.innerHTML = '<p style="color:red">Error loading inquiries: ' + e.message + '</p>'
  }
}

async function viewInquiry(id){
  try {
    const r = await fetch(`/api/get-inquiry?id=${id}`)
    if(!r.ok) throw new Error('Failed to load inquiry')
    
    const inquiry = await r.json()
    currentInquiry = inquiry

    const modal = document.getElementById('inquiry-modal')
    const detailDiv = document.getElementById('inquiry-detail')

    const routeLabels = {
      'locker-locker': 'Locker â†’ Locker',
      'locker-door': 'Locker â†’ Door',
      'locker-kiosk': 'Locker â†’ Kiosk',
      'kiosk-door': 'Kiosk â†’ Door'
    }

    detailDiv.innerHTML = `
      <h2>Inquiry Details</h2>
      
      <div class="detail-row">
        <div class="detail-label">Status</div>
        <div class="detail-value"><span class="status-badge status-${inquiry.status}">${inquiry.status}</span></div>
      </div>

      <div class="detail-row">
        <div class="detail-label">Client Information</div>
        <div class="detail-value">
          <strong>Name:</strong> ${inquiry.client.name}<br>
          <strong>Email:</strong> ${inquiry.client.email}<br>
          <strong>Phone:</strong> ${inquiry.client.phone}<br>
          <strong>Address:</strong> ${inquiry.client.address}
        </div>
      </div>

      <div class="detail-row">
        <div class="detail-label">Products</div>
        <div class="detail-value">
          <div class="items-list">
            ${inquiry.items.map(item => `
              <div class="item-row">
                <span>${item.name} x${item.qty} (${item.pudoSize})</span>
                <span>R${item.lineTotal.toFixed(2)}</span>
              </div>
            `).join('')}
          </div>
        </div>
      </div>

      <div class="detail-row">
        <div class="detail-label">Shipping</div>
        <div class="detail-value">
          <strong>Route:</strong> ${routeLabels[inquiry.shipping.route] || inquiry.shipping.route}<br>
          <strong>Size:</strong> ${inquiry.shipping.size}<br>
          <strong>Cost:</strong> R${inquiry.shipping.cost.toFixed(2)}
        </div>
      </div>

      <div class="totals-box">
        <div class="totals-row">
          <span>Products Subtotal:</span>
          <span>R${inquiry.totals.products.toFixed(2)}</span>
        </div>
        <div class="totals-row">
          <span>Shipping:</span>
          <span>R${inquiry.totals.shipping.toFixed(2)}</span>
        </div>
        <div class="totals-row totals-total">
          <span>Total:</span>
          <span>R${inquiry.totals.total.toFixed(2)}</span>
        </div>
      </div>

      <div style="margin-top:20px">
        ${inquiry.invoiceUrl ? `
          <a href="${inquiry.invoiceUrl}" target="_blank" class="download-link" style="display:inline-block;margin-right:12px;padding:10px 16px;background:#0aa7a7;color:#fff;text-decoration:none;border-radius:6px;font-weight:600">
            ðŸ“„ Download Invoice
          </a>
        ` : ''}
        <button onclick="generateInvoiceFromInquiry('${inquiry.id}')" ${inquiry.status === 'invoiced' ? 'disabled' : ''}>
          Generate Invoice
        </button>
      </div>
    `

    modal.style.display = 'block'
  } catch(e) {
    alert('Error loading inquiry: ' + e.message)
  }
}

function closeModal(){
  document.getElementById('inquiry-modal').style.display = 'none'
  currentInquiry = null
}

async function generateInvoiceFromInquiry(id){
  try {
    // Get inquiry details
    const r = await fetch(`/api/get-inquiry?id=${id}`)
    if(!r.ok) throw new Error('Failed to load inquiry')
    
    const inquiry = await r.json()

    // Generate invoice
    const invoiceR = await fetch('/api/create-invoice', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        inquiryId: inquiry.id,
        items: inquiry.items.map(item => ({ name: item.name, qty: item.qty })),
        route: inquiry.shipping.route,
        client: inquiry.client,
        shipping: inquiry.shipping,
        totals: inquiry.totals
      })
    })

    if(!invoiceR.ok) {
      const errorText = await invoiceR.text()
      let errorMessage = 'Failed to generate invoice'
      try {
        const errorJson = JSON.parse(errorText)
        errorMessage = errorJson.error || errorMessage
      } catch(e) {
        errorMessage = errorText || errorMessage
      }
      throw new Error(errorMessage)
    }

    const invoiceData = await invoiceR.json()

    // Store invoice URL in inquiry
    await fetch('/api/store-invoice-url', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ id: inquiry.id, invoiceUrl: invoiceData.url })
    })

    // Update inquiry status
    await fetch('/api/update-inquiry-status', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ id: inquiry.id, status: 'invoiced' })
    })

    // Show result
    alert('Invoice generated! Download link: ' + invoiceData.url)
    window.open(invoiceData.url, '_blank')
    
    // Refresh inquiries list
    loadInquiries()
    
    // Update modal if open
    if(currentInquiry && currentInquiry.id === id) {
      viewInquiry(id)
    }
  } catch(e) {
    alert('Error generating invoice: ' + e.message)
  }
}

// Close modal on outside click
document.getElementById('inquiry-modal').addEventListener('click', function(e) {
  if(e.target === this) {
    closeModal()
  }
})

function getStatusColor(status) {
  const colors = {
    'pending': '#fff3cd',
    'invoice-sent': '#cfe2ff',
    'payment-received': '#d1e7dd',
    'shipped': '#d0d4f7',
    'invoiced': '#d4edda',
    'reviewed': '#d1ecf1'
  }
  return colors[status] || '#f8f9fa'
}

async function updateInquiryStatus(id, status) {
  try {
    const r = await fetch('/api/update-inquiry-status', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ id, status })
    })

    if(!r.ok) {
      const errorText = await r.text()
      let errorMessage = 'Failed to update status'
      try {
        const errorJson = JSON.parse(errorText)
        errorMessage = errorJson.error || errorMessage
      } catch(e) {
        errorMessage = errorText || errorMessage
      }
      throw new Error(errorMessage)
    }

    // Refresh inquiries list to show updated status
    loadInquiries()
  } catch(e) {
    alert('Error updating status: ' + e.message)
    // Reload to reset dropdown
    loadInquiries()
  }
}
</script>

</body>
</html>
